<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Drama Live Translator</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Animation utilities */
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (SVG Components) ---
        const Icon = ({ path, className }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {path}
            </svg>
        );

        const Icons = {
            Activity: (props) => <Icon {...props} path={<><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></>} />,
            Mic: (props) => <Icon {...props} path={<><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></>} />,
            Monitor: (props) => <Icon {...props} path={<><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></>} />,
            Settings: (props) => <Icon {...props} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            X: (props) => <Icon {...props} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            ExternalLink: (props) => <Icon {...props} path={<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></>} />,
            Layers: (props) => <Icon {...props} path={<><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>} />,
            Palette: (props) => <Icon {...props} path={<><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></>} />,
            Maximize: (props) => <Icon {...props} path={<><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></>} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />
        };

        // --- MAIN COMPONENT ---
        const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed select-none";
            const variants = {
                primary: "bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-500/20 active:scale-95",
                secondary: "bg-gray-700 hover:bg-gray-600 text-gray-100 active:scale-95",
                danger: "bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-500/20 active:scale-95",
                ghost: "hover:bg-gray-800 text-gray-300 hover:text-white active:scale-95",
                outline: "border border-gray-600 text-gray-300 hover:border-gray-400 hover:text-white active:scale-95"
            };
            return (
                <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-gray-900/90 backdrop-blur-md border border-gray-800 rounded-xl p-6 ${className}`}>
                {children}
            </div>
        );

        function App() {
            const [isCapturing, setIsCapturing] = useState(false);
            const [sourceType, setSourceType] = useState('system'); 
            const [apiKey, setApiKey] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [obsMode, setObsMode] = useState(false);
            const [alertMsg, setAlertMsg] = useState('');
            
            const [styles, setStyles] = useState({
                fontSize: 28,
                textColor: '#ffffff',
                bgColor: '#000000',
                bgOpacity: 60,
                fontFamily: 'sans-serif',
                fontWeight: '700'
            });

            const [transcript, setTranscript] = useState("Waiting for audio...");
            const [translation, setTranslation] = useState("");
            const [isTranslating, setIsTranslating] = useState(false);

            const recognitionRef = useRef(null);
            const streamRef = useRef(null);
            const pipWindowRef = useRef(null);

            useEffect(() => {
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) setApiKey(savedKey);
                return () => stopCapture();
            }, []);

            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('gemini_api_key', key);
            };

            const showAlert = (msg) => {
                setAlertMsg(msg);
                setTimeout(() => setAlertMsg(''), 5000);
            };

            const translateText = async (text) => {
                if (!text || !apiKey || text.trim().length < 2) return;
                
                setIsTranslating(true);
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: `Translate this Korean text to English for subtitles. 
                                        Rules: Concise, Natural. If meaning is ambiguous, add (Tagalog: <translation>) at end.
                                        Korean: "${text}"`
                                    }]
                                }]
                            })
                        }
                    );

                    const data = await response.json();
                    if (data.error) {
                        showAlert("API Error: Check Key");
                    } else if (data.candidates && data.candidates[0].content) {
                        setTranslation(data.candidates[0].content.parts[0].text);
                    }
                } catch (error) {
                    console.error("Translation network error:", error);
                } finally {
                    setIsTranslating(false);
                }
            };

            const startCapture = async () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    showAlert("Browser not supported. Please use Google Chrome.");
                    return;
                }

                try {
                    let stream;
                    if (sourceType === 'system') {
                        try {
                            stream = await navigator.mediaDevices.getDisplayMedia({
                                video: true,
                                audio: {
                                    echoCancellation: false,
                                    autoGainControl: false,
                                    noiseSuppression: false
                                }
                            });
                        } catch (err) {
                            console.log("User cancelled selection");
                            return;
                        }
                        
                        const audioTrack = stream.getAudioTracks()[0];
                        if (!audioTrack) {
                            showAlert("No audio detected! Check 'Share tab audio' in popup.");
                            stream.getTracks().forEach(t => t.stop());
                            return;
                        }
                    } else {
                        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    }

                    streamRef.current = stream;
                    stream.getTracks().forEach(track => {
                        track.onended = stopCapture;
                    });

                    const recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'ko-KR';

                    recognition.onstart = () => {
                        setIsCapturing(true);
                        setTranscript("Listening...");
                        setTranslation("");
                    };

                    recognition.onerror = (event) => {
                        if (event.error === 'not-allowed') {
                            stopCapture();
                            showAlert("Microphone/Audio permission denied.");
                        }
                    };

                    recognition.onend = () => {
                        if (streamRef.current?.active) {
                            try { recognition.start(); } catch(e) {}
                        } else {
                            setIsCapturing(false);
                        }
                    };

                    recognition.onresult = (event) => {
                        let finalTranscript = '';
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                finalTranscript = event.results[i][0].transcript;
                                setTranscript(finalTranscript);
                                translateText(finalTranscript);
                            } else {
                                // optional: show interim
                            }
                        }
                    };

                    recognitionRef.current = recognition;
                    recognition.start();

                } catch (err) {
                    console.error("Error starting capture:", err);
                    showAlert("Failed to start. Ensure secure context (HTTPS/localhost).");
                    setIsCapturing(false);
                }
            };

            const stopCapture = () => {
                if (recognitionRef.current) recognitionRef.current.stop();
                if (streamRef.current) streamRef.current.getTracks().forEach(track => track.stop());
                setIsCapturing(false);
                setTranscript("Paused");
                setTranslation("");
            };

            const togglePiP = async () => {
                if (!window.documentPictureInPicture) {
                    showAlert("PiP not supported in this browser.");
                    return;
                }
                if (window.documentPictureInPicture.window) {
                    window.documentPictureInPicture.window.close();
                    return;
                }

                try {
                    const pipWindow = await window.documentPictureInPicture.requestWindow({ width: 800, height: 300 });
                    pipWindowRef.current = pipWindow;

                    // Copy styles
                    [...document.styleSheets].forEach((styleSheet) => {
                        try {
                            if (styleSheet.href) {
                                const link = document.createElement('link');
                                link.rel = 'stylesheet';
                                link.type = styleSheet.type;
                                link.media = styleSheet.media;
                                link.href = styleSheet.href;
                                pipWindow.document.head.appendChild(link);
                            } else if (styleSheet.cssRules) {
                                const cssRules = [...styleSheet.cssRules].map((rule) => rule.cssText).join('');
                                const style = document.createElement('style');
                                style.textContent = cssRules;
                                pipWindow.document.head.appendChild(style);
                            }
                        } catch (e) {}
                    });

                    const container = document.getElementById('caption-container');
                    const pipBody = pipWindow.document.body;
                    pipBody.style.backgroundColor = "black";
                    pipBody.style.display = "flex";
                    pipBody.style.justifyContent = "center";
                    pipBody.style.alignItems = "center";
                    pipBody.style.height = "100vh";
                    pipBody.style.margin = "0";
                    pipBody.appendChild(container);

                    pipWindow.addEventListener("pagehide", () => {
                        const mainContainerWrapper = document.getElementById('main-preview-area');
                        if (mainContainerWrapper && container) {
                            mainContainerWrapper.appendChild(container);
                        }
                        pipWindowRef.current = null;
                    });
                } catch (err) {
                    console.error("PiP failed:", err);
                    showAlert("Failed to open Picture-in-Picture.");
                }
            };

            const getContainerStyle = () => ({
                backgroundColor: obsMode ? 'transparent' : `rgba(0,0,0, ${styles.bgOpacity / 100})`,
                fontFamily: styles.fontFamily,
                textShadow: '2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000',
            });

            const getTextStyle = () => ({
                color: styles.textColor,
                fontSize: `${styles.fontSize}px`,
                fontWeight: styles.fontWeight,
                lineHeight: 1.2,
            });

            return (
                <div className={`min-h-screen ${obsMode ? 'bg-transparent' : 'bg-gray-950 text-white'} font-sans selection:bg-blue-500/30 transition-colors duration-300`}>
                    
                    {/* Alert Toast */}
                    {alertMsg && (
                        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-red-600 text-white px-6 py-3 rounded-lg shadow-xl animate-in flex items-center gap-2">
                            <Icons.AlertCircle className="w-5 h-5"/> {alertMsg}
                        </div>
                    )}

                    {!obsMode && (
                        <div className="container mx-auto p-4 max-w-4xl space-y-6">
                            <header className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/20">
                                        <Icons.Activity className="text-white w-6 h-6" />
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">
                                            K-Drama Live Translator
                                        </h1>
                                        <p className="text-xs text-gray-400">Powered by Gemini AI â€¢ Real-time</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <Button variant="outline" onClick={() => setObsMode(true)} title="Removes UI for OBS capture">
                                        <Icons.Layers className="w-4 h-4" />
                                        <span className="hidden sm:inline">OBS Mode</span>
                                    </Button>
                                    <Button variant="ghost" onClick={() => setShowSettings(!showSettings)}>
                                        <Icons.Settings className="w-5 h-5" />
                                    </Button>
                                </div>
                            </header>

                            <Card className="grid grid-cols-1 md:grid-cols-2 gap-6 relative overflow-hidden">
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <label className="text-sm font-medium text-gray-400 uppercase tracking-wider">Audio Source</label>
                                        {sourceType === 'system' && <span className="text-[10px] bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded">Check "Share Audio"</span>}
                                    </div>
                                    <div className="flex gap-2 bg-gray-800 p-1 rounded-lg">
                                        <button onClick={() => setSourceType('system')} className={`flex-1 py-2 px-3 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-all ${sourceType === 'system' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-400 hover:text-white'}`}>
                                            <Icons.Monitor className="w-4 h-4" /> System/App
                                        </button>
                                        <button onClick={() => setSourceType('mic')} className={`flex-1 py-2 px-3 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-all ${sourceType === 'mic' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-400 hover:text-white'}`}>
                                            <Icons.Mic className="w-4 h-4" /> Microphone
                                        </button>
                                    </div>
                                    {!apiKey && <div className="flex items-center gap-2 text-red-400 text-xs bg-red-900/20 p-2 rounded border border-red-900/50"><Icons.AlertCircle className="w-4 h-4" /><span>API Key required in settings.</span></div>}
                                </div>

                                <div className="space-y-3 flex flex-col justify-end">
                                   {!isCapturing ? (
                                      <Button onClick={startCapture} className="w-full justify-center py-3 text-lg">
                                        <Icons.Activity className="w-5 h-5" /> Start Listening
                                      </Button>
                                   ) : (
                                     <Button onClick={stopCapture} variant="danger" className="w-full justify-center py-3 text-lg animate-pulse">
                                        <Icons.X className="w-5 h-5" /> Stop Capture
                                     </Button>
                                   )}
                                   <Button variant="secondary" onClick={togglePiP} className="w-full justify-center text-sm">
                                     <Icons.ExternalLink className="w-4 h-4" /> Pop-out Overlay (PiP)
                                   </Button>
                                </div>
                            </Card>

                            {showSettings && (
                                <Card className="border-t-4 border-t-blue-500 animate-in">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold flex items-center gap-2"><Icons.Palette className="w-4 h-4 text-blue-400" /> Style & Config</h3>
                                        <button onClick={() => setShowSettings(false)} className="text-gray-400 hover:text-white"><Icons.X className="w-4 h-4"/></button>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-400 mb-1">Gemini API Key</label>
                                            <input type="password" value={apiKey} onChange={(e) => saveApiKey(e.target.value)} placeholder="Paste AI Studio Key..." className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-blue-500 outline-none"/>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Font Size: {styles.fontSize}px</label>
                                                    <input type="range" min="16" max="72" value={styles.fontSize} onChange={(e) => setStyles({...styles, fontSize: Number(e.target.value)})} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"/>
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Background Opacity: {styles.bgOpacity}%</label>
                                                    <input type="range" min="0" max="100" value={styles.bgOpacity} onChange={(e) => setStyles({...styles, bgOpacity: Number(e.target.value)})} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"/>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Text Color</label>
                                                    <div className="flex items-center gap-2 bg-gray-800 p-2 rounded border border-gray-700">
                                                        <input type="color" value={styles.textColor} onChange={(e) => setStyles({...styles, textColor: e.target.value})} className="w-6 h-6 rounded cursor-pointer bg-transparent border-0 p-0" />
                                                    </div>
                                                </div>
                                                <div>
                                                     <label className="block text-sm text-gray-400 mb-1">Bg Color</label>
                                                     <div className="flex items-center gap-2 bg-gray-800 p-2 rounded border border-gray-700">
                                                        <input type="color" value={styles.bgColor} onChange={(e) => setStyles({...styles, bgColor: e.target.value})} className="w-6 h-6 rounded cursor-pointer bg-transparent border-0 p-0" />
                                                     </div>
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="block text-sm text-gray-400 mb-1">Font Weight</label>
                                                    <select value={styles.fontWeight} onChange={(e) => setStyles({...styles, fontWeight: e.target.value})} className="w-full bg-gray-800 border border-gray-700 text-sm rounded-lg p-2 focus:ring-blue-500 outline-none">
                                                        <option value="400">Normal</option>
                                                        <option value="600">Semi Bold</option>
                                                        <option value="700">Bold</option>
                                                        <option value="900">Extra Bold</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </Card>
                            )}
                        </div>
                    )}

                    {obsMode && (
                        <div className="fixed top-4 right-4 z-50 opacity-0 hover:opacity-100 transition-opacity">
                           <Button variant="secondary" onClick={() => setObsMode(false)}>
                             <Icons.Maximize className="w-4 h-4" /> Exit OBS Mode
                           </Button>
                        </div>
                    )}

                    <div id="main-preview-area" className={`${obsMode ? 'fixed inset-0 flex flex-col justify-end pb-12 items-center' : 'max-w-4xl mx-auto px-4 pb-12 mt-6'}`}>
                        <div id="caption-container" className={`transition-all duration-300 w-full max-w-5xl rounded-xl flex flex-col items-center text-center p-6 ${obsMode ? 'mb-8' : ''}`} style={getContainerStyle()}>
                           <h2 className="font-medium mb-3 opacity-90 transition-all" style={{ color: styles.textColor, fontSize: `${styles.fontSize * 0.6}px`, textShadow: '1px 1px 2px rgba(0,0,0,0.8)' }}>
                             {transcript}
                           </h2>
                           <h1 className="font-bold transition-all tracking-wide" style={getTextStyle()}>
                             {translation || (isCapturing ? "..." : "")}
                           </h1>
                           {isTranslating && (
                             <div className="mt-4 flex gap-1 justify-center opacity-80">
                               <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
                               <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
                               <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
                             </div>
                           )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
